#!/usr/bin/env python
# Author: Zhuode Liu

# Replay the game using saved frames and gaze positions recorded in a ASC file 
# (ASC files are converted from EDF files, which are produced by EyeLink eyetracker)

import sys, pygame, time


if __name__ == "__main__":
    if len(sys.argv) < 3:
        print "Usage: %s saved_frames_png_dir asc_file" % (sys.argv[0])
        sys.exit(1)

    png_dir_path = sys.argv[1]
    asc_path = sys.argv[2]

    png_files = os.listdir(png_dir_path)
    png_files = preprocess_and_sanity_check(png_files)

    # init pygame
    xSCALE, ySCALE = 6, 3
    w, h = 160*xSCALE, 210*ySCALE
    pygame.init()
    pygame.display.set_mode((w, h), RESIZABLE | DOUBLEBUF | RLEACCEL, 32)
    screen = pygame.display.get_surface()

    clock = pygame.time.Clock()
    for (i,png) in enumerate(png_files):
        clock.tick(30)  # control FPS 
        s = pygame.image.load(png)
        s = pygame.transform.scale(s, (w,h), screen)
        pygame.display.flip()
        pygame.event.pump()


def preprocess_and_sanity_check(png_files):

    hasWarning = False

    for fname in png_files:
        if not fname.endswith(".png"):
            print ("Warning: %s is not a PNG file. Deleting it from the frames list" % fname)
            hasWarning = True
            png_files.remove(fname)

    def sorting_key(fname):
        a, b = os.path.splitext(fname)
        try:
            frameid = int(a)
        except ValueError as ex:
            raise ValueError("Error: cannot convert filename '%s' to frame ID (an integer)" % fname)
        return frameid
    png_files = sorted(png_files, key=sorting_key)

    prev_idx = 0
    for fname in png_files:
        # check if the index starts with one, and is free of gap (e.g. free of jumping from i to i+2)
        a, b = os.path.splitext(fname)
        while prev_idx + 1 != int(a):
            print ("Warning: there is a gap between frames. Missing frame ID: %d" % (prev_idx+1))
            hasWarning = True
            prev_idx += 1
        prev_idx += 1

    if hasWarning:
        print "There are warnings. Sleeping for 5 sec..."
        time.sleep(5)

    return png_files




# The method used in this script to align a gaze position to each frame is:
# For frame #i, attach the gaze position immediately before frame #i+1.
# That is, search for the last gaze position immediately before "MSG <timestamp> SCR_RECORDER FRAMEID i+1",
# An example having only 3 frames is given below

'''
MSG     472750 SCR_RECORDER FRAMEID 1
472750    485.3   305.9  1020.0 ...
472751    485.6   306.7  1019.0 ...
472752    485.9   307.8  1018.0 ...
472753    486.1   308.8  1017.0 ...
472754    486.6   309.3  1020.0 ...
472755    486.9   309.3  1023.0 ...
472756    486.0   309.4  1028.0 ...
472757    484.8   309.6  1027.0 ...
472758    483.6   309.9  1027.0 ...
472759    483.6   310.1  1025.0 ...
472760    483.6   310.0  1025.0 ...
472761    483.6   310.0  1027.0 ...
472762    483.6   309.9  1027.0 ...
472763    483.7   309.9  1027.0 ...
472764    483.7   309.9  1026.0 ...
472765    483.7   309.5  1027.0 ...
472766    483.7   309.1  1027.0 ...
472767    483.7   308.5  1027.0 ...
472768    483.7   308.1  1026.0 ...
472769    484.1   307.6  1026.0 ...
472770    484.5   307.4  1026.0 ...
472771    485.0   307.5  1026.0 ...
472772    485.2   307.8  1024.0 ...
472773    485.4   307.5  1023.0 ...
472774    485.4   307.1  1029.0 ...
472775    485.3   306.7  1035.0 ...
472776    485.1   306.7  1038.0 ...
472777    484.9   307.3  1035.0 ...
472778    484.8   307.7  1032.0 ...
472779    484.7   308.1  1032.0 ...
472780    484.6   308.1  1032.0 ...
472781    484.3   308.2  1036.0 ...
472782    484.1   308.3  1040.0 ...   <----- this gaze position gets attached to frame 1
MSG     472783 SCR_RECORDER FRAMEID 2
472783    484.2   308.4  1044.0 ...
472784    484.4   308.1  1041.0 ...
472785    484.7   307.8  1037.0 ...
472786    484.7   307.3  1034.0 ...
472787    485.1   307.0  1034.0 ...
472788    485.5   307.0  1035.0 ...
472789    485.7   307.7  1036.0 ...
472790    485.5   308.4  1037.0 ...
472791    485.1   308.9  1039.0 ...
472792    484.9   309.0  1040.0 ...
472793    484.7   308.7  1041.0 ...
472794    484.6   308.4  1041.0 ...
472795    484.5   308.6  1040.0 ...
472796    485.0   309.5  1040.0 ...
472797    485.6   310.3  1040.0 ...
472798    485.2   310.1  1041.0 ...
472799    484.3   308.1  1041.0 ...
472800    484.0   306.2  1041.0 ...
472801    484.8   304.6  1041.0 ...
472802    485.8   304.5  1042.0 ...
472803    486.0   304.9  1043.0 ...
472804    486.2   305.8  1046.0 ...
472805    485.4   307.2  1048.0 ...
472806    484.7   308.2  1047.0 ...
472807    483.7   308.8  1044.0 ...
472808    483.3   309.2  1042.0 ...
472809    482.8   309.6  1041.0 ...
472810    482.7   309.0  1041.0 ...
472811    482.9   308.0  1044.0 ...
472812    483.3   307.8  1048.0 ...
472813    483.6   308.5  1052.0 ...
472814    484.0   309.3  1050.0 ...  <----- this position gets attached to frame 2 
MSG     472815 SCR_RECORDER FRAMEID 3 <----- Frame 3, the last frame, has no gaze position attached to it
472815    484.2   309.2  1048.0 ...
472816    484.4   309.0  1047.0 ...
472817    484.4   309.0  1049.0 ...
472818    483.8   309.0  1050.0 ...
472819    483.1   309.6  1050.0 ...
'''